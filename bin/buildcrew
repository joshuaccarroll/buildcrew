#!/bin/bash
# BuildCrew - Autonomous AI Development Workflow
# https://github.com/joshuaccarroll/buildcrew

set -e

# Determine script location (follow symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
BUILDCREW_HOME="$(dirname "$SCRIPT_DIR")"

# Source library files
source "$BUILDCREW_HOME/lib/version.sh"
source "$BUILDCREW_HOME/lib/update.sh"
source "$BUILDCREW_HOME/lib/plugins.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

print_logo() {
    echo -e "${CYAN}"
    echo "  ____        _ _     _  ____                    "
    echo " | __ ) _   _(_) | __| |/ ___|_ __ _____      __ "
    echo " |  _ \\| | | | | |/ _\` | |   | '__/ _ \\ \\ /\\ / / "
    echo " | |_) | |_| | | | (_| | |___| | |  __/\\ V  V /  "
    echo " |____/ \\__,_|_|_|\\__,_|\\____|_|  \\___| \\_/\\_/   "
    echo -e "${NC}"
}

print_help() {
    print_logo
    echo -e "${BOLD}BuildCrew${NC} - Autonomous AI Development Workflow"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "    buildcrew <command> [options]"
    echo ""
    echo -e "${BOLD}COMMANDS:${NC}"
    echo "    init        Initialize BuildCrew in current project"
    echo "    run         Execute workflow on BACKLOG.md"
    echo "    plugins     Show recommended plugins for your project"
    echo "    update      Check for and install updates"
    echo "    version     Show version information"
    echo "    uninstall   Remove BuildCrew from system"
    echo "    help        Show this help message"
    echo ""
    echo -e "${BOLD}OPTIONS:${NC}"
    echo "    --single    Process only one task (with 'run')"
    echo "    --dry-run   Preview without executing (with 'run')"
    echo ""
    echo -e "${BOLD}GETTING STARTED:${NC}"
    echo -e "    1. Run ${CYAN}buildcrew init${NC} in your project"
    echo -e "    2. Run ${CYAN}buildcrew run${NC} to start"
    echo -e "    (Auto-launches build mode if no backlog exists)"
    echo ""
    echo -e "${BOLD}DOCUMENTATION:${NC}"
    echo "    https://github.com/joshuaccarroll/buildcrew"
    echo ""
}

cmd_init() {
    echo -e "${BOLD}Initializing BuildCrew in current project...${NC}"
    echo ""

    # Create .claude directory (minimal - uses global installation)
    mkdir -p .claude

    # Create .buildcrew-link marker pointing to global installation
    if [ ! -f ".claude/.buildcrew-link" ]; then
        echo "BUILDCREW_HOME=$BUILDCREW_HOME" > .claude/.buildcrew-link
        echo -e "  ${GREEN}✓${NC} Linked to BuildCrew at $BUILDCREW_HOME"
    else
        echo -e "  ${YELLOW}○${NC} BuildCrew link exists"
    fi

    # Create .buildcrew directory for project-specific overrides
    mkdir -p .buildcrew/rules

    # Create workflow.md.example if not present
    if [ ! -f ".buildcrew/workflow.md.example" ]; then
        cat > .buildcrew/workflow.md.example << 'EOF'
# Custom Workflow (Example)

Copy this file to workflow.md to customize your project's workflow.
Delete phases you don't need, or add new ones.

---

## Phases

### Phase 1: PLAN
agent: none
description: Create implementation plan

### Phase 2: BUILD
agent: feature-engineer
description: Implement the feature

### Phase 3: TEST
agent: qa-engineer
description: Write and run tests

### Phase 4: COMMIT
agent: none
description: Create git commit

---

## Available Agents

- principal-engineer: Architecture & code review
- feature-engineer: Pragmatic implementation
- security-engineer: Security audits
- qa-engineer: Testing
- product-manager: Product discovery
- ux-designer: Design specs

---

## Customization Tips

1. Remove PLAN_REVIEW and CODE_REVIEW for faster iteration
2. Add a DEPLOY phase after COMMIT for CI/CD
3. Change agents to match your team's needs
4. Add gate conditions to enforce quality

See ~/.buildcrew/workflows/default-workflow.md for the full default workflow.
EOF
        echo -e "  ${GREEN}✓${NC} Created .buildcrew/workflow.md.example"
    else
        echo -e "  ${YELLOW}○${NC} Workflow example exists"
    fi

    # Create project-rules.md.example if not present
    if [ ! -f ".buildcrew/rules/project-rules.md.example" ]; then
        cat > .buildcrew/rules/project-rules.md.example << 'EOF'
# Project-Specific Rules (Example)

Copy this file to project-rules.md to add custom rules for your project.
These rules extend the core BuildCrew principles.

---

## Override: Functions
<!-- Use ## Override: to replace a default rule -->
- Keep functions under 30 lines (default is 20)

## Extend: Custom Rules
<!-- Use ## Extend: to add to existing rules -->

### Linting & Formatting
- Run `npm run lint` before committing
- All TypeScript files must pass strict mode
- Use Prettier with project config

### Naming Conventions
- React components: PascalCase (UserProfile.tsx)
- Utilities: camelCase (formatDate.ts)
- Constants: SCREAMING_SNAKE_CASE
- Database tables: snake_case

### API Design
- All endpoints must return { data, error, meta }
- Use plural nouns for resource collections
- Version all public APIs: /v1/users

### Operational Rules
- API calls must use exponential backoff
- Batch updates to prevent thundering herd
- Rate limit external API calls to 10/sec

### Database
- All queries must use parameterized statements
- No N+1 query patterns
- Index foreign keys
- Use transactions for multi-step operations

### Frontend
- Components must be under 200 lines
- State management through designated store only
- All interactive elements must be keyboard accessible

## Disable: YAGNI
<!-- Use ## Disable: to remove a rule section entirely -->
<!-- Uncomment to disable YAGNI enforcement -->
EOF
        echo -e "  ${GREEN}✓${NC} Created .buildcrew/rules/project-rules.md.example"
    else
        echo -e "  ${YELLOW}○${NC} Rules example exists"
    fi

    # Create BACKLOG.md template if not present
    if [ ! -f "BACKLOG.md" ]; then
        cat > BACKLOG.md << 'EOF'
# Backlog

*Add your tasks here, then run `buildcrew run` to process them.*

## High Priority

- [ ] Your first task here

## Medium Priority

- [ ] Another task

## Low Priority

- [ ] Future task

---
*Use `/build` in Claude Code to generate a comprehensive backlog from your project plan.*
EOF
        echo -e "  ${GREEN}✓${NC} Created BACKLOG.md template"
    else
        echo -e "  ${YELLOW}○${NC} BACKLOG.md exists"
    fi

    # Create or update .claude/settings.json with comprehensive autonomous permissions
    if [ ! -f ".claude/settings.json" ]; then
        cat > .claude/settings.json << 'EOF'
{
  "permissions": {
    "allow": [
      "Read",
      "Write",
      "Edit",
      "Glob",
      "Grep",
      "TodoWrite",
      "WebFetch",
      "WebSearch",

      "Bash(npm:*)",
      "Bash(npx:*)",
      "Bash(yarn:*)",
      "Bash(pnpm:*)",
      "Bash(bun:*)",
      "Bash(node:*)",
      "Bash(deno:*)",

      "Bash(pip:*)",
      "Bash(pip3:*)",
      "Bash(python:*)",
      "Bash(python3:*)",
      "Bash(poetry:*)",
      "Bash(uv:*)",
      "Bash(pytest:*)",
      "Bash(ruff:*)",
      "Bash(black:*)",
      "Bash(mypy:*)",
      "Bash(flake8:*)",

      "Bash(go:*)",
      "Bash(cargo:*)",
      "Bash(rustc:*)",
      "Bash(rustfmt:*)",
      "Bash(clippy:*)",

      "Bash(mvn:*)",
      "Bash(gradle:*)",
      "Bash(ant:*)",

      "Bash(dotnet:*)",
      "Bash(nuget:*)",

      "Bash(ruby:*)",
      "Bash(bundle:*)",
      "Bash(gem:*)",
      "Bash(rake:*)",
      "Bash(rails:*)",

      "Bash(php:*)",
      "Bash(composer:*)",
      "Bash(artisan:*)",

      "Bash(swift:*)",
      "Bash(xcodebuild:*)",

      "Bash(make:*)",
      "Bash(cmake:*)",
      "Bash(ninja:*)",
      "Bash(gcc:*)",
      "Bash(g++:*)",
      "Bash(clang:*)",

      "Bash(docker:*)",
      "Bash(docker-compose:*)",
      "Bash(podman:*)",

      "Bash(kubectl:*)",
      "Bash(helm:*)",
      "Bash(terraform:*)",
      "Bash(pulumi:*)",

      "Bash(git status:*)",
      "Bash(git diff:*)",
      "Bash(git log:*)",
      "Bash(git show:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git branch:*)",
      "Bash(git checkout:*)",
      "Bash(git switch:*)",
      "Bash(git merge:*)",
      "Bash(git rebase:*)",
      "Bash(git stash:*)",
      "Bash(git fetch:*)",
      "Bash(git pull:*)",
      "Bash(git push:*)",
      "Bash(git tag:*)",
      "Bash(git remote:*)",
      "Bash(git cherry-pick:*)",
      "Bash(git rev-parse:*)",
      "Bash(git ls-files:*)",
      "Bash(git worktree:*)",

      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(head:*)",
      "Bash(tail:*)",
      "Bash(less:*)",
      "Bash(more:*)",
      "Bash(wc:*)",
      "Bash(sort:*)",
      "Bash(uniq:*)",
      "Bash(diff:*)",
      "Bash(comm:*)",
      "Bash(cut:*)",
      "Bash(tr:*)",
      "Bash(awk:*)",
      "Bash(sed:*)",
      "Bash(grep:*)",
      "Bash(egrep:*)",
      "Bash(fgrep:*)",
      "Bash(rg:*)",
      "Bash(ag:*)",
      "Bash(find:*)",
      "Bash(fd:*)",
      "Bash(locate:*)",
      "Bash(which:*)",
      "Bash(whereis:*)",
      "Bash(type:*)",
      "Bash(file:*)",
      "Bash(stat:*)",
      "Bash(du:*)",
      "Bash(df:*)",

      "Bash(mkdir:*)",
      "Bash(touch:*)",
      "Bash(cp:*)",
      "Bash(mv:*)",
      "Bash(rm:*)",
      "Bash(rmdir:*)",
      "Bash(ln:*)",
      "Bash(chmod:*)",

      "Bash(echo:*)",
      "Bash(printf:*)",
      "Bash(tee:*)",
      "Bash(xargs:*)",
      "Bash(env:*)",
      "Bash(printenv:*)",
      "Bash(export:*)",
      "Bash(source:*)",
      "Bash(date:*)",
      "Bash(time:*)",
      "Bash(sleep:*)",
      "Bash(true:*)",
      "Bash(false:*)",
      "Bash(test:*)",
      "Bash([:*)",

      "Bash(curl:*)",
      "Bash(wget:*)",
      "Bash(http:*)",
      "Bash(jq:*)",
      "Bash(yq:*)",
      "Bash(xmllint:*)",

      "Bash(tar:*)",
      "Bash(zip:*)",
      "Bash(unzip:*)",
      "Bash(gzip:*)",
      "Bash(gunzip:*)",
      "Bash(bzip2:*)",
      "Bash(xz:*)",

      "Bash(openssl:*)",
      "Bash(base64:*)",
      "Bash(md5:*)",
      "Bash(sha256sum:*)",
      "Bash(shasum:*)",

      "Bash(ps:*)",
      "Bash(top:*)",
      "Bash(htop:*)",
      "Bash(kill:*)",
      "Bash(pkill:*)",
      "Bash(lsof:*)",
      "Bash(netstat:*)",
      "Bash(ss:*)",

      "Bash(gh:*)",

      "Bash(./test.sh:*)",
      "Bash(./build.sh:*)",
      "Bash(./run.sh:*)",
      "Bash(./start.sh:*)",
      "Bash(./deploy.sh:*)",
      "Bash(./setup.sh:*)",
      "Bash(./scripts/*:*)",
      "Bash(bats:*)"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(su:*)",
      "Bash(doas:*)",

      "Bash(rm -rf /:*)",
      "Bash(rm -rf ~:*)",
      "Bash(rm -rf /*:*)",
      "Bash(rm -rf $HOME:*)",
      "Bash(rm -rf /etc:*)",
      "Bash(rm -rf /usr:*)",
      "Bash(rm -rf /var:*)",
      "Bash(rm -rf /bin:*)",
      "Bash(rm -rf /sbin:*)",
      "Bash(rm -rf /lib:*)",
      "Bash(rm -rf /boot:*)",
      "Bash(rm -rf /root:*)",
      "Bash(rm -rf /System:*)",
      "Bash(rm -rf /Applications:*)",
      "Bash(rm -rf /Library:*)",

      "Bash(git push --force:*)",
      "Bash(git push -f:*)",
      "Bash(git push origin --force:*)",
      "Bash(git push origin -f:*)",
      "Bash(git reset --hard HEAD~:*)",
      "Bash(git reset --hard origin:*)",
      "Bash(git clean -fdx:*)",
      "Bash(git clean -fd:*)",

      "Bash(mkfs:*)",
      "Bash(dd if=/dev/zero:*)",
      "Bash(dd of=/dev:*)",
      "Bash(> /dev/sda:*)",
      "Bash(chmod -R 777 /:*)",
      "Bash(chown -R:*)",

      "Bash(curl | sh:*)",
      "Bash(curl | bash:*)",
      "Bash(wget | sh:*)",
      "Bash(wget | bash:*)",

      "Bash(shutdown:*)",
      "Bash(reboot:*)",
      "Bash(halt:*)",
      "Bash(poweroff:*)",
      "Bash(init:*)",
      "Bash(systemctl:*)",
      "Bash(service:*)",
      "Bash(launchctl:*)",

      "Bash(ssh:*)",
      "Bash(scp:*)",
      "Bash(rsync:*)",

      "Read(**/.env)",
      "Read(**/.env.*)",
      "Read(**/*.pem)",
      "Read(**/*.key)",
      "Read(**/id_rsa*)",
      "Read(**/id_ed25519*)",
      "Read(**/.ssh/*)",
      "Read(**/credentials*)",
      "Read(**/secrets*)",
      "Read(**/.aws/*)",
      "Read(**/.gcloud/*)",
      "Read(**/.azure/*)"
    ]
  }
}
EOF
        echo -e "  ${GREEN}✓${NC} Created .claude/settings.json with autonomous permissions"
        echo -e "  ${YELLOW}⚠${NC}  Review .claude/settings.json - these permissions enable autonomous operation"
    else
        echo -e "  ${YELLOW}○${NC} .claude/settings.json exists"
    fi

    echo ""
    echo -e "${GREEN}${BOLD}BuildCrew initialized!${NC}"
    echo ""
    echo -e "${BOLD}What was created:${NC}"
    echo -e "  • ${CYAN}.claude/.buildcrew-link${NC} - Links to global BuildCrew installation"
    echo -e "  • ${CYAN}.claude/settings.json${NC} - Permissions for Claude Code"
    echo -e "  • ${CYAN}.buildcrew/${NC} - Directory for project-specific customization"
    echo -e "  • ${CYAN}BACKLOG.md${NC} - Your task backlog"
    echo ""
    echo -e "${BOLD}Optional customization:${NC}"
    echo -e "  • Copy ${CYAN}.buildcrew/workflow.md.example${NC} to ${CYAN}workflow.md${NC} to customize phases"
    echo -e "  • Copy ${CYAN}.buildcrew/rules/project-rules.md.example${NC} to add project rules"
    echo ""
    echo -e "${BOLD}Next steps:${NC}"
    echo -e "  1. Run ${CYAN}buildcrew run${NC} to start"
    echo -e "  2. Use ${CYAN}/buildcrew <persona>${NC} to invoke a persona ad-hoc"
    echo ""
}

cmd_plugins() {
    print_logo
    echo -e "${BOLD}Plugin Recommendations${NC}"
    echo ""
    check_plugins
}

cmd_run() {
    # Check for updates (non-blocking)
    check_for_updates &

    # Verify we're in a project with BuildCrew initialized
    if [ ! -f "BACKLOG.md" ]; then
        echo -e "${RED}Error:${NC} No BACKLOG.md found in current directory."
        echo ""
        echo "Either:"
        echo "  1. Run ${CYAN}buildcrew init${NC} to initialize BuildCrew"
        echo "  2. Create a BACKLOG.md file with tasks"
        echo "  3. Use ${CYAN}/build${NC} in Claude Code to generate one"
        exit 1
    fi

    # Show plugin tip on first run
    if ! plugins_already_checked; then
        show_plugin_tip
    fi

    # Pass through to workflow script
    exec "$BUILDCREW_HOME/lib/workflow.sh" "$@"
}

cmd_update() {
    echo -e "${BOLD}Checking for updates...${NC}"
    echo ""

    local current=$(get_version)
    local latest=$(fetch_latest_version)

    if [ -z "$latest" ]; then
        echo -e "${RED}Error:${NC} Could not fetch latest version. Check your internet connection."
        exit 1
    fi

    if [ "$current" = "$latest" ]; then
        echo -e "${GREEN}✓${NC} BuildCrew is up to date (v$current)"
        exit 0
    fi

    echo -e "Update available: ${YELLOW}v$current${NC} → ${GREEN}v$latest${NC}"
    echo ""

    read -p "Install update? [y/N] " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "Downloading v$latest..."

        local tmp_dir=$(mktemp -d)
        local archive="$tmp_dir/buildcrew.tar.gz"

        curl -fsSL "https://github.com/joshuaccarroll/buildcrew/archive/refs/tags/v$latest.tar.gz" -o "$archive"

        echo "Installing..."
        tar -xzf "$archive" -C "$tmp_dir"

        # Run the installer from the new version
        "$tmp_dir/buildcrew-$latest/install.sh" --upgrade

        rm -rf "$tmp_dir"

        echo ""
        echo -e "${GREEN}✓${NC} Updated to v$latest"
    else
        echo "Update cancelled."
    fi
}

cmd_version() {
    local version=$(get_version)
    echo -e "${BOLD}BuildCrew${NC} v$version"
    echo "https://github.com/joshuaccarroll/buildcrew"
}

cmd_uninstall() {
    echo -e "${BOLD}Uninstalling BuildCrew...${NC}"
    echo ""
    echo "This will remove:"
    echo "  - ~/.buildcrew/"
    echo "  - ~/.local/bin/buildcrew symlink"
    echo ""
    echo -e "${YELLOW}Note:${NC} Project files (.claude/, BACKLOG.md, etc.) will NOT be removed."
    echo ""

    read -p "Continue? [y/N] " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$HOME/.buildcrew"
        rm -f "$HOME/.local/bin/buildcrew"
        rm -f "/usr/local/bin/buildcrew" 2>/dev/null || true

        echo ""
        echo -e "${GREEN}✓${NC} BuildCrew has been uninstalled."
        echo ""
        echo -e "${YELLOW}Note:${NC} If you added BuildCrew to your PATH, remove this line from your shell config:"
        echo -e "  ${CYAN}export PATH=\"\$HOME/.local/bin:\$PATH\"${NC}"
        echo ""
        echo "Common locations: ~/.bashrc, ~/.zshrc, ~/.profile, ~/.bash_profile"
        echo ""
        echo "To reinstall, run:"
        echo "  curl -fsSL https://raw.githubusercontent.com/joshuaccarroll/buildcrew/main/install.sh | bash"
    else
        echo "Uninstall cancelled."
    fi
}

# Main command dispatch
case "${1:-}" in
    init)
        shift
        cmd_init "$@"
        ;;
    run)
        shift
        cmd_run "$@"
        ;;
    plugins)
        shift
        cmd_plugins "$@"
        ;;
    update)
        shift
        cmd_update "$@"
        ;;
    version|--version|-v)
        cmd_version
        ;;
    uninstall)
        cmd_uninstall
        ;;
    help|--help|-h|"")
        print_help
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command '$1'"
        echo ""
        echo "Run 'buildcrew help' for usage information."
        exit 1
        ;;
esac
